<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Chat P2P</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        /* Hide scrollbar but allow scroll */
        #chat-messages::-webkit-scrollbar { display: none; }
        #chat-messages { -ms-overflow-style: none; scrollbar-width: none; }

        /* Bubble animations */
        .bubble-in {
            animation: bubbleAppear 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes bubbleAppear {
            from { opacity: 0; transform: translateY(12px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Pulse for status dot */
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Connected pulse */
        .pulse-connected {
            animation: pulseGreen 1.5s infinite;
        }
        @keyframes pulseGreen {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.5); }
            50% { box-shadow: 0 0 0 6px rgba(34,197,94,0); }
        }

        /* Gradient background */
        .bg-gradient-main {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }

        /* Input focus ring */
        input:focus { outline: none; }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            transition: all 0.2s ease;
        }
        .btn-primary:active {
            transform: scale(0.97);
            filter: brightness(0.9);
        }
        .btn-secondary {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            transition: all 0.2s ease;
        }
        .btn-secondary:active {
            transform: scale(0.97);
            background: rgba(99, 102, 241, 0.25);
        }

        .id-display {
            background: rgba(99, 102, 241, 0.1);
            border: 1px dashed rgba(99, 102, 241, 0.4);
        }

        .msg-sent {
            background: linear-gradient(135deg, #6366f1, #7c3aed);
            border-radius: 18px 18px 4px 18px;
        }
        .msg-received {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 18px 18px 18px 4px;
        }

        .screen-transition {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-main text-white h-dvh w-screen overflow-hidden flex flex-col">

    <!-- ==================== STATUS BAR ==================== -->
    <header class="flex items-center justify-between px-4 py-3 border-b border-white/10 shrink-0" style="background:rgba(15,23,42,0.95); backdrop-filter:blur(10px);">
        <div class="flex items-center gap-2">
            <div class="text-lg font-bold tracking-tight">ðŸ’¬ Chat P2P</div>
        </div>
        <div id="status-badge" class="flex items-center gap-2 text-xs font-medium px-3 py-1.5 rounded-full bg-white/5 border border-white/10">
            <span id="status-dot" class="w-2 h-2 rounded-full bg-amber-400 pulse-dot"></span>
            <span id="status-text">Sin conexiÃ³n</span>
        </div>
    </header>

    <!-- ==================== PANTALLA DE CONEXIÃ“N ==================== -->
    <main id="screen-connect" class="flex-1 flex flex-col overflow-y-auto">
        <div class="flex-1 flex flex-col items-center justify-center px-6 py-8 gap-6 max-w-md mx-auto w-full">

            <!-- Logo / Hero -->
            <div class="text-center mb-2">
                <div class="text-5xl mb-3">ðŸ”—</div>
                <h1 class="text-2xl font-bold mb-1">ConexiÃ³n P2P</h1>
                <p class="text-sm text-gray-400 leading-relaxed">Conecta directamente con otro dispositivo.<br>Sin servidores. Sin intermediarios.</p>
            </div>

            <!-- PASO 1: Generar ID -->
            <div class="w-full">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                    <span class="w-5 h-5 rounded-full bg-indigo-500/20 text-indigo-400 flex items-center justify-center text-[10px] font-bold">1</span>
                    Tu identificador
                </div>

                <div id="id-section-empty">
                    <button id="btn-generate" onclick="generateId()" class="btn-primary w-full text-white font-semibold py-3.5 px-6 rounded-xl text-sm">
                        âš¡ Generar Mi ID
                    </button>
                </div>

                <div id="id-section-ready" class="hidden">
                    <div class="id-display rounded-xl p-3 flex items-center justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="text-xs text-gray-400 mb-0.5">Tu ID:</div>
                            <div id="my-id-display" class="text-base font-mono font-bold text-indigo-300 truncate">â€”</div>
                        </div>
                        <button onclick="copyId()" class="btn-secondary text-indigo-300 text-xs font-semibold py-2 px-3 rounded-lg shrink-0 flex items-center gap-1.5">
                            <span id="copy-icon">ðŸ“‹</span>
                            <span id="copy-text">Copiar</span>
                        </button>
                    </div>
                    <p class="text-[11px] text-gray-500 mt-2 text-center">Comparte este ID con la otra persona</p>
                </div>
            </div>

            <!-- PASO 2: Conectar -->
            <div class="w-full">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                    <span class="w-5 h-5 rounded-full bg-indigo-500/20 text-indigo-400 flex items-center justify-center text-[10px] font-bold">2</span>
                    Conectar con otro
                </div>
                <div class="flex gap-2">
                    <input
                        id="remote-id-input"
                        type="text"
                        placeholder="Pega el ID del otro aquÃ­"
                        class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3.5 text-sm text-white placeholder-gray-500 font-mono"
                        autocomplete="off"
                        autocorrect="off"
                        autocapitalize="off"
                        spellcheck="false"
                    >
                    <button id="btn-connect" onclick="connectToPeer()" class="btn-primary text-white font-semibold py-3.5 px-5 rounded-xl text-sm shrink-0 disabled:opacity-40" disabled>
                        Conectar
                    </button>
                </div>
            </div>

            <!-- Waiting / Info -->
            <div id="waiting-msg" class="hidden text-center py-4">
                <div class="inline-flex items-center gap-2 text-sm text-gray-400">
                    <svg class="animate-spin h-4 w-4 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <span id="waiting-text">Esperando conexiÃ³n...</span>
                </div>
            </div>

        </div>
    </main>

    <!-- ==================== PANTALLA DE CHAT ==================== -->
    <main id="screen-chat" class="flex-1 flex-col hidden overflow-hidden">

        <!-- Peer info bar -->
        <div id="peer-info-bar" class="flex items-center gap-3 px-4 py-2.5 border-b border-white/5 shrink-0" style="background:rgba(15,23,42,0.6);">
            <div class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-sm">ðŸ‘¤</div>
            <div class="flex-1 min-w-0">
                <div id="peer-name" class="text-sm font-semibold truncate">Conectado</div>
                <div id="peer-id-small" class="text-[11px] text-gray-500 font-mono truncate">â€”</div>
            </div>
            <button onclick="disconnect()" class="text-xs text-red-400 font-medium py-1.5 px-3 rounded-lg bg-red-400/10 border border-red-400/20">
                Salir
            </button>
        </div>

        <!-- Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto px-4 py-3 flex flex-col gap-2">
            <!-- System message -->
            <div class="text-center py-4">
                <span class="text-[11px] text-gray-500 bg-white/5 px-3 py-1 rounded-full">ConexiÃ³n establecida ðŸŽ‰</span>
            </div>
        </div>

        <!-- Input bar -->
        <div class="shrink-0 border-t border-white/10 px-3 py-3" style="background:rgba(15,23,42,0.95); backdrop-filter:blur(10px);">
            <div class="flex items-end gap-2 max-w-lg mx-auto">
                <input
                    id="msg-input"
                    type="text"
                    placeholder="Escribe un mensaje..."
                    class="flex-1 bg-white/8 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white placeholder-gray-500 focus:border-indigo-500/50"
                    autocomplete="off"
                    autocorrect="on"
                    enterkeyhint="send"
                >
                <button id="btn-send" onclick="sendMessage()" class="btn-primary w-11 h-11 rounded-full flex items-center justify-center text-lg shrink-0 disabled:opacity-30" disabled>
                    âž¤
                </button>
            </div>
        </div>
    </main>

    <!-- ==================== TOAST NOTIFICATION ==================== -->
    <div id="toast" class="fixed top-16 left-1/2 -translate-x-1/2 bg-gray-800 border border-white/10 text-white text-xs font-medium px-4 py-2.5 rounded-xl shadow-2xl transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none z-50">
        <span id="toast-msg">Mensaje</span>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // ===== ESTADO GLOBAL =====
        let peer = null;
        let conn = null;
        let myId = '';
        let isConnected = false;

        // ===== ELEMENTOS DOM =====
        const $ = (id) => document.getElementById(id);

        const screenConnect = $('screen-connect');
        const screenChat = $('screen-chat');
        const statusDot = $('status-dot');
        const statusText = $('status-text');
        const statusBadge = $('status-badge');
        const myIdDisplay = $('my-id-display');
        const remoteIdInput = $('remote-id-input');
        const btnConnect = $('btn-connect');
        const btnGenerate = $('btn-generate');
        const chatMessages = $('chat-messages');
        const msgInput = $('msg-input');
        const btnSend = $('btn-send');
        const waitingMsg = $('waiting-msg');
        const peerIdSmall = $('peer-id-small');

        // ===== HABILITAR BOTÃ“N CONECTAR AL ESCRIBIR =====
        remoteIdInput.addEventListener('input', () => {
            btnConnect.disabled = remoteIdInput.value.trim().length === 0 || !peer;
        });

        // ===== ENVIAR CON ENTER =====
        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ===== HABILITAR BOTÃ“N ENVIAR AL ESCRIBIR =====
        msgInput.addEventListener('input', () => {
            btnSend.disabled = msgInput.value.trim().length === 0;
        });

        // ===== GENERAR ID =====
        function generateId() {
            btnGenerate.textContent = 'â³ Conectando al servidor...';
            btnGenerate.disabled = true;

            // Generar un ID corto y fÃ¡cil de compartir
            const shortId = 'p2p-' + Math.random().toString(36).substring(2, 8);

            console.log('[PeerJS] Creando peer con ID:', shortId);

            peer = new Peer(shortId, {
                debug: 1 // Nivel de debug mÃ­nimo
            });

            peer.on('open', (id) => {
                myId = id;
                console.log('[PeerJS] âœ… Conectado al servidor de seÃ±alizaciÃ³n. Mi ID:', id);

                // Actualizar UI
                $('id-section-empty').classList.add('hidden');
                $('id-section-ready').classList.remove('hidden');
                myIdDisplay.textContent = id;

                updateStatus('waiting', 'Esperando par...');
                btnConnect.disabled = remoteIdInput.value.trim().length === 0;

                // Escuchar conexiones entrantes
                peer.on('connection', handleIncomingConnection);
            });

            peer.on('error', (err) => {
                console.error('[PeerJS] âŒ Error:', err.type, err.message);

                if (err.type === 'unavailable-id') {
                    // ID ya en uso, reintentar con otro
                    showToast('ID en uso, reintentando...');
                    peer.destroy();
                    setTimeout(generateId, 500);
                    return;
                }

                if (err.type === 'peer-unavailable') {
                    showToast('âŒ No se encontrÃ³ ese ID');
                    waitingMsg.classList.add('hidden');
                    btnConnect.disabled = false;
                    return;
                }

                if (err.type === 'network' || err.type === 'server-error' || err.type === 'socket-error' || err.type === 'socket-closed') {
                    showToast('âš ï¸ Error de red. Revisa tu conexiÃ³n.');
                    updateStatus('disconnected', 'Error de red');
                }

                // Resetear si no estamos conectados
                if (!isConnected) {
                    $('id-section-empty').classList.remove('hidden');
                    $('id-section-ready').classList.add('hidden');
                    btnGenerate.textContent = 'âš¡ Generar Mi ID';
                    btnGenerate.disabled = false;
                }
            });

            peer.on('disconnected', () => {
                console.log('[PeerJS] âš ï¸ Desconectado del servidor de seÃ±alizaciÃ³n');
                if (!isConnected) {
                    updateStatus('disconnected', 'Desconectado');
                }
                // Intentar reconectar
                if (peer && !peer.destroyed) {
                    console.log('[PeerJS] Intentando reconectar...');
                    setTimeout(() => {
                        if (peer && !peer.destroyed) peer.reconnect();
                    }, 2000);
                }
            });
        }

        // ===== CONECTAR A OTRO PEER =====
        function connectToPeer() {
            const remoteId = remoteIdInput.value.trim();
            if (!remoteId || !peer) return;

            if (remoteId === myId) {
                showToast('âŒ No puedes conectarte a ti mismo');
                return;
            }

            console.log('[PeerJS] Intentando conectar a:', remoteId);
            btnConnect.disabled = true;
            $('waiting-text').textContent = 'Conectando...';
            waitingMsg.classList.remove('hidden');

            const dataConn = peer.connect(remoteId, {
                reliable: true,
                serialization: 'json'
            });

            setupConnection(dataConn);
        }

        // ===== MANEJAR CONEXIÃ“N ENTRANTE =====
        function handleIncomingConnection(dataConn) {
            console.log('[PeerJS] ðŸ“¥ ConexiÃ³n entrante de:', dataConn.peer);

            // Si ya tenemos conexiÃ³n, rechazar
            if (isConnected && conn) {
                console.log('[PeerJS] Ya conectado, rechazando nueva conexiÃ³n');
                return;
            }

            showToast('ðŸ“¥ ConexiÃ³n entrante...');
            setupConnection(dataConn);
        }

        // ===== CONFIGURAR CONEXIÃ“N =====
        function setupConnection(dataConn) {
            conn = dataConn;

            conn.on('open', () => {
                isConnected = true;
                console.log('[PeerJS] âœ… ConexiÃ³n P2P establecida con:', conn.peer);

                updateStatus('connected', 'Conectado');
                showChatScreen(conn.peer);
                showToast('âœ… Â¡Conectado!');

                // Vibrar al conectar
                vibrate(200);
            });

            conn.on('data', (data) => {
                console.log('[PeerJS] ðŸ“© Mensaje recibido:', data);

                if (data && data.type === 'chat-message') {
                    addMessage(data.text, false, data.timestamp);
                    vibrate(100);
                }
            });

            conn.on('close', () => {
                console.log('[PeerJS] ðŸ”Œ ConexiÃ³n cerrada por el par');
                handleDisconnection('El otro usuario se desconectÃ³');
            });

            conn.on('error', (err) => {
                console.error('[PeerJS] âŒ Error en la conexiÃ³n:', err);
                showToast('âš ï¸ Error en la conexiÃ³n');
            });

            // Timeout de conexiÃ³n
            setTimeout(() => {
                if (!isConnected && conn === dataConn) {
                    console.log('[PeerJS] â° Timeout de conexiÃ³n');
                    showToast('â° Tiempo agotado. Verifica el ID.');
                    waitingMsg.classList.add('hidden');
                    btnConnect.disabled = remoteIdInput.value.trim().length === 0;
                    conn = null;
                }
            }, 15000);
        }

        // ===== ENVIAR MENSAJE =====
        function sendMessage() {
            const text = msgInput.value.trim();
            if (!text || !conn || !isConnected) return;

            const timestamp = Date.now();

            const messageData = {
                type: 'chat-message',
                text: text,
                timestamp: timestamp
            };

            try {
                conn.send(messageData);
                addMessage(text, true, timestamp);
                msgInput.value = '';
                btnSend.disabled = true;
                msgInput.focus();
                console.log('[PeerJS] ðŸ“¤ Mensaje enviado:', text);
            } catch (err) {
                console.error('[PeerJS] âŒ Error al enviar:', err);
                showToast('âŒ Error al enviar el mensaje');
            }
        }

        // ===== AGREGAR MENSAJE A LA LISTA =====
        function addMessage(text, isMine, timestamp) {
            const time = new Date(timestamp).toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const wrapper = document.createElement('div');
            wrapper.className = `flex ${isMine ? 'justify-end' : 'justify-start'} bubble-in`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] px-3.5 py-2.5 ${isMine ? 'msg-sent text-white' : 'msg-received text-gray-100'}`;

            const textEl = document.createElement('div');
            textEl.className = 'text-sm leading-relaxed break-words whitespace-pre-wrap';
            textEl.textContent = text;

            const timeEl = document.createElement('div');
            timeEl.className = `text-[10px] mt-1 ${isMine ? 'text-indigo-200/60 text-right' : 'text-gray-500'}`;
            timeEl.textContent = time;

            bubble.appendChild(textEl);
            bubble.appendChild(timeEl);
            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);

            // Auto-scroll
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // ===== DESCONECTAR =====
        function disconnect() {
            if (conn) {
                conn.close();
            }
            handleDisconnection('Te has desconectado');
        }

        function handleDisconnection(reason) {
            isConnected = false;
            conn = null;

            console.log('[PeerJS] ðŸ”Œ DesconexiÃ³n:', reason);

            // Volver a pantalla de conexiÃ³n
            screenChat.classList.add('hidden');
            screenChat.classList.remove('flex');
            screenConnect.classList.remove('hidden');

            // Limpiar chat
            chatMessages.innerHTML = `
                <div class="text-center py-4">
                    <span class="text-[11px] text-gray-500 bg-white/5 px-3 py-1 rounded-full">ConexiÃ³n establecida ðŸŽ‰</span>
                </div>
            `;

            updateStatus('waiting', 'Esperando par...');
            waitingMsg.classList.add('hidden');
            remoteIdInput.value = '';
            btnConnect.disabled = true;

            showToast(reason);
            vibrate(300);
        }

        // ===== MOSTRAR PANTALLA DE CHAT =====
        function showChatScreen(peerId) {
            screenConnect.classList.add('hidden');
            screenChat.classList.remove('hidden');
            screenChat.classList.add('flex');

            peerIdSmall.textContent = peerId;
            msgInput.focus();
        }

        // ===== ACTUALIZAR ESTADO =====
        function updateStatus(state, text) {
            statusText.textContent = text;

            statusDot.classList.remove('bg-amber-400', 'bg-green-400', 'bg-red-400', 'pulse-dot', 'pulse-connected');

            switch (state) {
                case 'connected':
                    statusDot.classList.add('bg-green-400', 'pulse-connected');
                    statusBadge.className = 'flex items-center gap-2 text-xs font-medium px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/20';
                    break;
                case 'waiting':
                    statusDot.classList.add('bg-amber-400', 'pulse-dot');
                    statusBadge.className = 'flex items-center gap-2 text-xs font-medium px-3 py-1.5 rounded-full bg-amber-500/10 border border-amber-500/20';
                    break;
                case 'disconnected':
                    statusDot.classList.add('bg-red-400');
                    statusBadge.className = 'flex items-center gap-2 text-xs font-medium px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/20';
                    break;
            }
        }

        // ===== COPIAR ID =====
        async function copyId() {
            try {
                await navigator.clipboard.writeText(myId);
                $('copy-icon').textContent = 'âœ…';
                $('copy-text').textContent = 'Â¡Copiado!';
                showToast('ðŸ“‹ ID copiado al portapapeles');
                setTimeout(() => {
                    $('copy-icon').textContent = 'ðŸ“‹';
                    $('copy-text').textContent = 'Copiar';
                }, 2000);
            } catch (err) {
                // Fallback para navegadores sin clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = myId;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                $('copy-icon').textContent = 'âœ…';
                $('copy-text').textContent = 'Â¡Copiado!';
                showToast('ðŸ“‹ ID copiado');
                setTimeout(() => {
                    $('copy-icon').textContent = 'ðŸ“‹';
                    $('copy-text').textContent = 'Copiar';
                }, 2000);
            }
        }

        // ===== TOAST =====
        let toastTimeout;
        function showToast(msg) {
            const toast = $('toast');
            $('toast-msg').textContent = msg;
            toast.classList.remove('opacity-0', '-translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');

            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-4');
                toast.classList.remove('opacity-100', 'translate-y-0');
            }, 2500);
        }

        // ===== VIBRACIÃ“N =====
        function vibrate(ms) {
            try {
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate(ms);
                }
            } catch (e) {
                console.log('[Vibration] No soportada');
            }
        }

        // ===== MANEJAR VISIBILIDAD (para reconexiones) =====
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && peer && !peer.destroyed && !peer.disconnected) {
                console.log('[PeerJS] App volviÃ³ al frente');
            }
        });

        // ===== PREVENIR CIERRE ACCIDENTAL =====
        window.addEventListener('beforeunload', (e) => {
            if (isConnected) {
                e.preventDefault();
                e.returnValue = 'Â¿Seguro que quieres salir? Se cerrarÃ¡ el chat.';
            }
        });

        console.log('[Chat P2P] ðŸš€ AplicaciÃ³n lista. Genera tu ID para comenzar.');
    </script>
</body>
</html>
